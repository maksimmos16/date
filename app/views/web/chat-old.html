{% extends "web/partation/layout.html" %}

{% block body %}

    <!-- mid part start -->
    <div class="mid-part">
        <!-- messages start -->
        <section class="messages-feed">
            <div class="container">
                <ul class="nav nav-pills" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="messages-tab" data-toggle="pill" href="#messages" role="tab" aria-controls="messages" aria-selected="true">Messages</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="feed-tab" data-toggle="pill" href="#feed" role="tab" aria-controls="feed" aria-selected="false">Feed</a>
                    </li>
                </ul>
                <div class="tab-content" id="pills-tabContent">
                    <!-- message start -->
                    <div class="tab-pane fade show active" id="messages" role="tabpanel" aria-labelledby="messages-tab">
                        <div class="message">
                            <div class="free-chat">Your Free Chat Expires in <span>71:58:36</span></div>
                            <div class="msg-sidepanel">
                                <div class="msg-sidepanel-closeBtn"><i class="flava-close"></i></div>
                                <div class="msg-profile-col" id="msg-profile-col">
                                    {% for user in sideList %}
                                        <a href="#" class="msg-profile sideList active cnt_{{user.userId[0]}}" data-flag="on" data-id="{{user.userId[0]}}">
                                            <div class="img"><img src="{{config.baseUrl}}{{user.photo[0]}}" alt=""></div>
                                            <div class="name">{{user.username[0]}}</div>
                                        </a>
                                    {% endfor %}
                                    <!-- <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-2.jpg" alt=""></div>
                                        <div class="name">Lehan Dross</div>
                                        <div class="count">2</div>
                                    </a>
                                    <a href="#" class="msg-profile active">
                                        <div class="img"><img src="images/pls-img-3.jpg" alt=""></div>
                                        <div class="name">Karolina</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-4.jpg" alt=""></div>
                                        <div class="name">Andreevna</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/ssc-img-2.jpg" alt=""></div>
                                        <div class="name">Karina Simons</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/ssc-img-4.jpg" alt=""></div>
                                        <div class="name">Lehan Dross</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-2.jpg" alt=""></div>
                                        <div class="name">Lehan Dross</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-4.jpg" alt=""></div>
                                        <div class="name">Andreevna</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-1.jpg" alt=""></div>
                                        <div class="name">Karina Simons</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-2.jpg" alt=""></div>
                                        <div class="name">Lehan Dross</div>
                                        <div class="count">2</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-3.jpg" alt=""></div>
                                        <div class="name">Karolina</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-4.jpg" alt=""></div>
                                        <div class="name">Andreevna</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/ssc-img-2.jpg" alt=""></div>
                                        <div class="name">Karina Simons</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/ssc-img-4.jpg" alt=""></div>
                                        <div class="name">Lehan Dross</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-2.jpg" alt=""></div>
                                        <div class="name">Lehan Dross</div>
                                    </a>
                                    <a href="#" class="msg-profile">
                                        <div class="img"><img src="images/pls-img-4.jpg" alt=""></div>
                                        <div class="name">Andreevna</div>
                                    </a> -->
                                </div>
                            </div>
                            <div class="msg-content chatModule">
                                <div class="msg-sidepanel-btn"><i class="flava-left-arrow"></i></div>
                                <div class="mc-top">
                                    <div class="mc-profile" id="daterId" data-id="{{sideList[0].userId[0]}}">
                                        <div class="profile-img"><img src="{{config.baseUrl}}{{sideList[0].photo[0]}}" alt=""></div>
                                        <div class="profile-name">{{sideList[0].username[0]}}</div>
                                    </div>
                                    <div class="phone-video">
                                        <a href="#" class="pv-btn"><i class="flava-call"></i></a>
                                        <a href="#" class="pv-btn"><i class="flava-video-call"></i></a>
                                        <div class="dropdown block-report">
                                            <a class="btn" href="#" data-toggle="dropdown">
                                                <i class="flava-menu"></i>
                                            </a>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item" href="#">Block</a>
                                                <a class="dropdown-item" href="#">Unmatch</a>
                                                <a class="dropdown-item" href="#">Report</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mc-mid">
                                    <div id="mc-mid-scroll">
                                        {% for chat in chatHistory %}
                                            <div class="chat-date">{{chat.date}}</div>
                                            {% if chat.flag == 'left' %}
                                                <div class="chat-text-box">
                                                    <div class="chat-text"><div class="time">{{chat.time}}</div>{{chat.message}}</div>
                                                </div>
                                            {% else %}
                                                <div class="chat-text-box right">
                                                    <div class="chat-text"><div class="time">{{chat.time}}</div>{{chat.message}}</div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                        <!-- <div class="chat-date">February 16th, 2020</div>
                                        <div class="chat-text-box">
                                            <div class="chat-text"><div class="time">2:43 pm</div> Lorem Ipsum is simply dummy text </div>
                                        </div>
                                        <div class="chat-text-box right">
                                            <div class="chat-text"><div class="time">2:43 pm</div> Lorem Ipsum is simply dummy text of the </div>
                                        </div>
                                        <div class="chat-date">February 16th, 2020</div>
                                        <div class="chat-text-box">
                                            <div class="chat-text"><div class="time">2:43 pm</div> Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum is simply dummy text of the printing and typesetting industry.</div>
                                        </div>
                                        <div class="chat-text-box right">
                                            <div class="chat-text"><div class="time">2:43 pm</div> Lorem Ipsum is simply dummy text of the printing and typesetting industry.</div>
                                        </div>
                                        <div class="chat-date">February 16th, 2020</div>
                                        <div class="chat-text-box">
                                            <div class="chat-text"><div class="time">2:43 pm</div> Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum is simply dummy text of the printing and typesetting industry.</div>
                                        </div>
                                        <div class="chat-text-box right">
                                            <div class="chat-text"><div class="time">2:43 pm</div> Lorem Ipsum is simply dummy text of the printing and typesetting industry.</div>
                                        </div>
                                        <div class="chat-date">February 16th, 2020</div>
                                        <div class="chat-text-box">
                                            <div class="chat-text"><div class="time">2:43 pm</div> Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum is simply dummy text of the printing and typesetting industry.</div>
                                        </div>
                                        <div class="chat-text-box right">
                                            <div class="chat-text"><div class="time">2:43 pm</div> Lorem Ipsum is simply dummy text of the printing and typesetting industry.</div>
                                        </div> -->
                                    </div>
                                </div>
                                <div class="mc-botm">
                                    <div class="chat-type">
                                        <a href="#" class="smiley"><i class="flava-smiley"></i></a>
                                        <input type="text" class="form-control type-text" id="sndMsg" placeholder="Type a message">
                                        <a href="#" class="send sendMessage"><i class="flava-send"></i></a>
                                    </div>
                                    <div class="picture-like">
                                        <a href="#" class="pl-icon"><i class="flava-picture"></i></a>
                                        <a href="#" class="pl-icon"><i class="flava-heart"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- message end -->

                    <!-- feed start -->
                    <div class="tab-pane fade" id="feed" role="tabpanel" aria-labelledby="feed-tab">
                        <div class="feed">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="feed-col">
                                        <div class="feed-col-top">
                                            <div class="fct-img"><img src="images/pls-img-3.jpg" alt=""></div>
                                            <div class="fct-name">Andreevna’s Instagram posts</div>
                                        </div>
                                        <div class="img-masonry masonry-col ">
                                            <div class="im-col">
                                                <div class="img-box"><img src="images/im-col-1.jpg" alt=""></div>
                                            </div>
                                            <div class="im-col">
                                                <div class="im-col-row"><div class="img-box"><img src="images/im-col-2.jpg" alt=""></div></div>
                                                <div class="im-col-row"><div class="img-box"><img src="images/im-col-3.jpg" alt=""></div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="feed-col">
                                        <div class="feed-col-top">
                                            <div class="fct-img"><img src="images/pls-img-3.jpg" alt=""></div>
                                            <div class="fct-name">Andreevna’s Facebook posts</div>
                                        </div>
                                        <div class="img-masonry masonry-col ">
                                            <div class="im-col">
                                                <div class="img-box"><img src="images/im-col-4.jpg" alt=""></div>
                                            </div>
                                            <div class="im-col">
                                                <div class="img-box"><img src="images/im-col-5.jpg" alt=""></div>
                                            </div>
                                        </div>
                                        <!-- <div class="img-masonry masonry-row">
                                            <div class="im-col">
                                                <div class="img-box"><img src="images/temp.jpg" alt=""></div>
                                            </div>
                                            <div class="im-col">
                                                <div class="im-row-col"><div class="img-box"><img src="images/im-col-2.jpg" alt=""></div></div>
                                                <div class="im-row-col"><div class="img-box"><img src="images/im-col-3.jpg" alt=""></div></div>
                                            </div>
                                        </div> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- feed end -->
                </div>
            </div>
        </section>
        <!-- messages end -->
    </div>
    <!-- mid part end -->
    
{% endblock %}

{% block Jscript %}
    
    <script type="text/javascript" src="/web/js/jquery.min.js"></script>
    <script type="text/javascript" src="/web/js/popper.min.js"></script>
    <script type="text/javascript" src="/web/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/web/js/moment.js"></script>
    <script type="text/javascript" src="/web/js/jquery.slimscroll.js"></script>
    <!-- message scroll start -->
    <script>
    $(document).ready(function() {

        function customDataFormat(date) {
            let options = {
                hour: "2-digit", minute: "2-digit"  
            };
            return new Date(date).toLocaleString("en-us", options);
        }

        // [ Chat ]
        $('body').on('click', '.sideList', function(){
            let daterId = $(this).attr('data-id');
            console.log('daterId: ',daterId);
            $.ajax({
                url: "/getMessages",
                type: 'POST',
                headers: { 'token': token },
                data: { daterId: daterId },
                success: function (result) {
                    console.log('Result: ',result);
                    console.log('bs: ',bs);
                    if(result.chat.length > 0){
                        let html = `<div class="msg-content chatModule">
                                        <div class="msg-sidepanel-btn"><i class="flava-left-arrow"></i></div>
                                        <div class="mc-top">
                                            <div class="mc-profile" id="daterId" data-id="`+result.user._id+`">
                                                <div class="profile-img"><img src="`+bs+``+result.user.userPhoto[0].path+`" alt=""></div>
                                                <div class="profile-name">`+result.user.username+`</div>
                                            </div>
                                            <div class="phone-video">
                                                <a href="#" class="pv-btn"><i class="flava-call"></i></a>
                                                <a href="#" class="pv-btn"><i class="flava-video-call"></i></a>
                                                <div class="dropdown block-report">
                                                    <a class="btn" href="#" data-toggle="dropdown">
                                                        <i class="flava-menu"></i>
                                                    </a>
                                                    <div class="dropdown-menu">
                                                        <a class="dropdown-item" href="#">Block</a>
                                                        <a class="dropdown-item" href="#">Unmatch</a>
                                                        <a class="dropdown-item" href="#">Report</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mc-mid">
                                            <div id="mc-mid-scroll">`;
                        for (let i = 0; i < result.chat.length; i++) {
                            html += `           <div class="chat-date">`+result.chat[i].date+`</div>`;
                                            if(result.chat[i].flag == 'left'){
                                                html += `<div class="chat-text-box">
                                                            <div class="chat-text"><div class="time">`+result.chat[i].time+`</div>`+result.chat[i].message+`</div>
                                                         </div>`;
                                            }
                                            else{
                                                html += `<div class="chat-text-box right">
                                                            <div class="chat-text"><div class="time">`+result.chat[i].time+`</div>`+result.chat[i].message+`</div>
                                                         </div>`;
                                            }
                        }
                                html += `   </div>
                                        </div>
                                        <div class="mc-botm">
                                            <div class="chat-type">
                                                <a href="#" class="smiley"><i class="flava-smiley"></i></a>
                                                <input type="text" class="form-control type-text" id="sndMsg" placeholder="Type a message">
                                                <a href="#" class="sendMessage"><i class="flava-send"></i></a>
                                            </div>
                                            <div class="picture-like">
                                                <a href="#" class="pl-icon"><i class="flava-picture"></i></a>
                                                <a href="#" class="pl-icon"><i class="flava-heart"></i></a>
                                            </div>
                                        </div>
                                    </div>`;
                        $('.chatModule').replaceWith(html);
                    }
                }
            });
        });

        // [ Send Message ]
        $('body').on('click', '.sendMessage', function(){
            let daterId = $('#daterId').attr('data-id');
            let message = $('#sndMsg').val();
            console.log('daterId: ',daterId);
            console.log('userId: ',userId);
            socket.emit('sendmessage',{
                senderId: userId,
                receiverId: daterId,
                message: message
            },function(){
            });
            let dt = new Date();
            dt = customDataFormat(dt);
            let html = `<div class="chat-text-box right">
                            <div class="chat-text"><div class="time">`+dt+`</div>`+message+`</div>
                        </div>`;
            $('#mc-mid-scroll').last().append(html);
            $("#sndMsg").val('');
        });

        socket.on('emitMessage', function (body) {
            console.log('emitMessage: ',body);
            let cnt = $('.cnt_'+body.id).attr('data-flag');
            console.log('cnt: ',cnt);
            let dt = customDataFormat(body.chatData.createdAt);
            if (cnt == 'on') {
                // [ Only Append ]
                let html = `<div class="chat-text-box">
                                <div class="chat-text"><div class="time">`+dt+`</div>`+body.chatData.message+`</div>
                            </div>`;
                $('#mc-mid-scroll').last().append(html);
            }
            else {
                // [ Set Count ]
            }
            // $('.notiAnii').addClass('noti-active');
            // $('.noti-count').text(body.ncount);
        });

        if ($(window).width() < 767) {
            $('#msg-profile-col').slimScroll({
                height: '450px',
                railVisible: true,
            });
        } else {
            $('#msg-profile-col').slimScroll({
                height: '600px',
                railVisible: true,
            });
        }
    });

    $(document).ready(function() {
        if ($(window).width() < 767) {
            $('#mc-mid-scroll').slimScroll({
                height: '300px',
                railVisible: true,
            });
        } else {
            $('#mc-mid-scroll').slimScroll({
                height: '440px',
                railVisible: true,
            });
        }
    });
    </script>
    <script>
    $(document).ready(function() {
        $(".msg-sidepanel-btn").click(function() {
            $(this).addClass('mob-msg-sidepanel-btn');
            $(".msg-sidepanel").addClass("mob-msg-sidepanel");
        });

        $('body').on('click', '.msg-sidepanel-closeBtn', function() {
            $(".msg-sidepanel").removeClass("mob-msg-sidepanel");
            $(".msg-sidepanel-btn").css("display", "block");
        });
    });
    </script>
    <!-- message scroll end -->

{% endblock %}